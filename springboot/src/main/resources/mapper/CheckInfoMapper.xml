<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.springboot.mapper.CheckInfoMapper">

    <select id="getCheckInfo" resultType="com.example.springboot.response.CheckInfo">
        SELECT c.check_id As checkId,
        c.check_name As checkName,
        first_approval.manip_time AS createTime,
        c.check_desc As checkDesc,
        c.check_site AS checkSite,
        c.check_content AS checkContent,
        COALESCE(first_user.username, '未开始') AS creator,
        c.start_time AS startTime,
        c.end_time AS endTime,
        c.equip_id AS equipId,
        c.status AS status,
        CASE
        WHEN first_user.user_id = last_user.user_id THEN '未开始'
        ELSE COALESCE(last_user.username, '未开始')
        END AS updatePerson,
        CASE
        WHEN first_user.user_id = last_user.user_id THEN NULL
        ELSE last_approval.manip_time
        END AS updateTime
        FROM check_info c
        LEFT JOIN
        (SELECT ai.check_id,
        ai.manip_time,
        ai.applicant_id
        FROM approval_info ai
        WHERE ai.manip_time = (SELECT MIN(inside_ai.manip_time)
        FROM approval_info inside_ai
        WHERE inside_ai.check_id = ai.check_id)) first_approval
        ON c.check_id = first_approval.check_id
        LEFT JOIN
        (SELECT ai.check_id,
        ai.manip_time,
        ai.applicant_id
        FROM approval_info ai
        WHERE ai.manip_time = (SELECT MAX(inside_ai.manip_time)
        FROM approval_info inside_ai
        WHERE inside_ai.check_id = ai.check_id)) last_approval
        ON c.check_id = last_approval.check_id
        LEFT JOIN user_info first_user
        ON first_approval.applicant_id = first_user.user_id
        LEFT JOIN user_info last_user
        ON last_approval.applicant_id = last_user.user_id
        WHERE c.is_deleted = 0
        <!-- 动态条件 -->
        <if test="checkInfoReq != null">
            <if test="checkInfoReq.status != null and checkInfoReq.status.size() > 0">
                AND c.status IN
                <foreach item="status" collection="checkInfoReq.status" open="(" separator="," close=")">
                    #{status}
                </foreach>
            </if>
            <if test="checkInfoReq.checkName != null and checkInfoReq.checkName!=''">
                AND c.check_name LIKE concat('%', #{checkInfoReq.checkName}, '%')
            </if>
            <!-- 动态添加开始日期 -->
            <if test="checkInfoReq.startTime != null">
                AND c.start_time &gt;= #{checkInfoReq.startTime}
            </if>
            <!-- 动态添加结束日期 -->
            <if test="checkInfoReq.endTime != null">
                AND c.end_time &lt;= #{checkInfoReq.endTime}
            </if>
            <if test="checkInfoReq !=null and checkInfoReq.creator != '' ">
                AND COALESCE(first_user.username, '未开始') = #{checkInfoReq.creator}
            </if>
            <if test="checkInfoReq.equipId != null and checkInfoReq.equipId !='' ">
                AND c.equip_id = #{checkInfoReq.equipId}
            </if>
        </if>
    </select>
</mapper>
