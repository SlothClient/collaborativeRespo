<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.springboot.mapper.OrderMapper">
    <!-- 分页查询，可通过工单编号和时间范围筛选 -->
    <select id="getOrdersByPage" parameterType="com.example.springboot.utils.Condition" resultType="com.example.springboot.entity.OrderInfo">
        select order_info.*,maintance_info.plan_name,maintance_info.end_time planTime,worker_info.worker_name
        from order_info,maintance_info,worker_info
        <where>
            /* 必须条件设置为永真 */
            <if test="true">
                order_info.plan_id = maintance_info.plan_id and order_info.worker_id = worker_info.worker_id
            </if>
            <if test="orderId != null and orderId != ''">
                and order_id like CONCAT('%',#{orderId},'%')
            </if>
            <if test="startTime != null and endTime != null">
                /* 两张表中都存在开始与结束时间的字段，不指定报错ambiguous，即字段不确定，往前端查错没用 */
                and order_info.start_time &gt; #{startTime} and order_info.end_time &lt; #{endTime}
            </if>
        </where>
        limit #{limit} offset #{offset}
    </select>
    <!-- 条件查询（筛选）后的总数据条数 -->
    <select id="getOrdersCountByCondition">
        select count(*)
        from order_info,maintance_info
        <where>
            <if test="true">
                order_info.plan_id = maintance_info.plan_id
            </if>
            <if test="orderId != null and orderId != ''">
                and order_id like CONCAT('%',#{orderId},'%')
            </if>
        </where>
    </select>
    <!-- 获取选中工单记录的设备信息 -->
    <select id="getSelectedEquipInfo" parameterType="com.example.springboot.utils.Condition" resultType="com.example.springboot.entity.SelectedEquipInfo">
        select eq.equip_name,
               eq.equip_id,
               eq.last_maintance,
               mt.maintance_desc,
               od.order_desc,
               od.order_record
        from equip_info eq,maintance_info mt,order_info od
        where eq.equip_id = #{equipId} and mt.plan_id = od.plan_id and mt.plan_id = #{planId}
    </select>
    <!-- 提交工作记录 -->
    <update id="addWorkRecord" parameterType="com.example.springboot.utils.Condition">
        update order_info
        set order_record = #{orderRecord}
        where order_id = #{orderId}
    </update>
</mapper>
